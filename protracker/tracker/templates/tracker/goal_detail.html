{% extends "tracker/base.html" %}

{% block header %}
    Goal
{% endblock %}
{% block subheader %}
    {{ goal.description }}
{% endblock %}

{% block content %}
{% load static %}
<script src="{% static 'node_modules/chart.js/dist/Chart.js' %}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7"></script>

<div id="content-top" class="pure-g">
    <div class="pure-u-1-2">
        <h2>Milestones</h2>
        <div id="milestone-list">
            <table class="pure-table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Total Hours</th>
                        <th>Hours Remaining</th>
                        <th>Reward</th>
                    </tr>
                </thead>
                <tbody>
                    {% for milestone in goal.milestone_set.all %}
                    <tr>
                        <td><a href="{% url 'tracker:milestone detail' goal.id milestone.id %}">{{ milestone.description }}</a></td>
                        <td>{{ milestone.hours }}</td>
                        <td>{{ milestone.hours_remaining }}</td>
                        {% for reward in goal.reward_set.all %}
                        {% if reward.milestone.id == milestone.id %}
                        <td><a href="{% url 'tracker:reward detail' goal.id reward.id %}">{{ reward.description }}</a></td>
                        {% else %}
                        <td></td>
                        {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="pure-u-1-2">
        <div id="session-list">
            <h2>Sessions</h2>
            <table class="pure-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Hours</th>
                        <th>Difficulty</th>
                        <th>Milestone</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in goal.session_set.all %}
                    <tr>
                        <td><a href="{% url 'tracker:session detail' goal.id session.id %}">{{ session.date }}</a></td>
                        <td>{{ session.hour_count }}</td>
                        <td>{{ session.get_difficulty_display }}</td>
                        <td>{{ session.milestone.description }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<div id="content-bottom" class="pure-g">
    <div class="pure-u-1-1">
        <canvas id="myChart"></canvas>
    </div>
</div>

<!-- Chart.js code -->
<script>
    var endpoint = '/tracker/api/graph/data/{{ goal.id }}'
    var labels = []
    var timeline = []
    var sessions_total = []
    var sessions = []


    $.ajax({
        method: "GET",
        url: endpoint,
        success: function(data){
            labels = data.labels
            timeline = data.timeline
            sessions_total = data.sessions_total
            sessions = data.sessions
            var ctx = document.getElementById('myChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'goal timeline',
                        data: timeline,
                        pointRadius: 0
                    }, {
                        label: 'sessions individual',
                        backgroundColor: 'rgb(50, 205, 50)',
                        borderColor: 'rgb(34, 139, 34)',
                        data: sessions,
                        pointRadius: 5
                    }, {
                        label: 'sessions totalled',
                        //backgroundColor: 'rgb(0, 102, 204)',
                        borderColor: 'rgb(236, 98, 95)',
                        data: sessions_total,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1500
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                }
            });
        }
    });
    </script>


{% endblock %}